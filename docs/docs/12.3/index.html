<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>12.3 | 使用 Golang 打造 Web 應用程式</title>


<link rel="stylesheet" href="/buildWebWithGolangTw/book.min.89885fa0429ec73067282f26fc0c6d38cfc617a443ec4e835d47b821c52c6e92.css" integrity="sha256-iYhfoEKexzBnKC8m/AxtOM/GF6RD7E6DXUe4IcUsbpI=">


<script defer src="/buildWebWithGolangTw/search.min.4762838110f5450a8a33fcbe56c7ce734d09867f3e9ab5c1e6f7bbec99b65c68.js" integrity="sha256-R2KDgRD1RQqKM/y&#43;VsfOc00Jhn8&#43;mrXB5ve77Jm2XGg="></script>



<link rel="icon" href="/buildWebWithGolangTw/favicon.png" type="image/x-icon">

<base href="https://ezzdoc.com/buildWebWithGolangTw/">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://ezzdoc.com/buildWebWithGolangTw/"><span>使用 Golang 打造 Web 應用程式</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" readonly />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    
  
  
  

  <style>
  nav ul a[href$="\2f buildWebWithGolangTw\2f docs\2f 12.3\2f "] {
      color: #004ed0;
  }
  </style>

<ul>
<li><a href="/buildWebWithGolangTw/docs/preface/">目錄</a></li>
<li><a href="/buildWebWithGolangTw/docs/01.0/">1.Go 環境配置</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/01.1/">1.1 安裝 Go</a></li>
<li><a href="/buildWebWithGolangTw/docs/01.2/">1.2 GOPATH 與工作空間</a></li>
<li><a href="/buildWebWithGolangTw/docs/01.3/">1.3 Go 命令</a></li>
<li><a href="/buildWebWithGolangTw/docs/01.4/">1.4 Go 開發工具</a></li>
<li><a href="/buildWebWithGolangTw/docs/01.5/">1.5 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/02.0/">2.Go 語言基礎</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/02.1/">2.1 你好，Go</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.2/">2.2 Go 基礎</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.3/">2.3 流程和函式</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.4/">2.4 struct</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.5/">2.5 物件導向</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.6/">2.6 interface</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.7/">2.7 併發</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.8/">2.8 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/03.0/">3.Web 基礎</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/03.1/">3.1 web 工作方式</a></li>
<li><a href="/buildWebWithGolangTw/docs/03.2/">3.2 Go 建立一個簡單的 web 服務</a></li>
<li><a href="/buildWebWithGolangTw/docs/03.3/">3.3 Go 如何使得 web 工作</a></li>
<li><a href="/buildWebWithGolangTw/docs/03.4/">3.4 Go 的 http 套件詳解</a></li>
<li><a href="/buildWebWithGolangTw/docs/03.5/">3.5 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/04.0/">4.表單</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/04.1/">4.1 處理表單的輸入</a></li>
<li><a href="/buildWebWithGolangTw/docs/04.2/">4.2 驗證表單的輸入</a></li>
<li><a href="/buildWebWithGolangTw/docs/04.3/">4.3 預防跨站指令碼</a></li>
<li><a href="/buildWebWithGolangTw/docs/04.4/">4.4 防止多次提交表單</a></li>
<li><a href="/buildWebWithGolangTw/docs/04.5/">4.5 處理檔案上傳</a></li>
<li><a href="/buildWebWithGolangTw/docs/04.6/">4.6 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/05.0/">5.訪問資料庫</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/05.1/">5.1 database/sql 介面</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.2/">5.2 使用 MySQL 資料庫</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.3/">5.3 使用 SQLite 資料庫</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.4/">5.4 使用 PostgreSQL 資料庫</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.5/">5.5 使用 Beego orm 函式庫進行 ORM 開發</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.6/">5.6 NOSQL 資料庫操作</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.7/">5.7 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/06.0/">6.session 和資料儲存</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/06.1/">6.1 session 和 cookie</a></li>
<li><a href="/buildWebWithGolangTw/docs/06.2/">6.2 Go 如何使用 session</a></li>
<li><a href="/buildWebWithGolangTw/docs/06.3/">6.3 session 儲存</a></li>
<li><a href="/buildWebWithGolangTw/docs/06.4/">6.4 預防 session 劫持</a></li>
<li><a href="/buildWebWithGolangTw/docs/06.5/">6.5 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/07.0/">7.文字檔案處理</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/07.1/">7.1 XML 處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.2/">7.2 JSON 處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.3/">7.3 正則處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.4/">7.4 範本處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.5/">7.5 檔案操作</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.6/">7.6 字串處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.7/">7.7 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/08.0/">8.Web 服務</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/08.1/">8.1 Socket 程式設計</a></li>
<li><a href="/buildWebWithGolangTw/docs/08.2/">8.2 WebSocket</a></li>
<li><a href="/buildWebWithGolangTw/docs/08.3/">8.3 REST</a></li>
<li><a href="/buildWebWithGolangTw/docs/08.4/">8.4 RPC</a></li>
<li><a href="/buildWebWithGolangTw/docs/08.5/">8.5 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/09.0/">9.安全與加密</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/09.1/">9.1 預防 CSRF 攻擊</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.2/">9.2 確保輸入過濾</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.3/">9.3 避免 XSS 攻擊</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.4/">9.4 避免 SQL 注入</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.5/">9.5 儲存密碼</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.6/">9.6 加密和解密資料</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.7/">9.7 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/10.0/">10.國際化和本地化</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/10.1/">10.1 設定預設地區</a></li>
<li><a href="/buildWebWithGolangTw/docs/10.2/">10.2 本地化資源</a></li>
<li><a href="/buildWebWithGolangTw/docs/10.3/">10.3 國際化站點</a></li>
<li><a href="/buildWebWithGolangTw/docs/10.4/">10.4 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/11.0/">11.錯誤處理，除錯和測試</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/11.1/">11.1 錯誤處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/11.2/">11.2 使用 GDB 除錯</a></li>
<li><a href="/buildWebWithGolangTw/docs/11.3/">11.3 Go 怎麼寫測試案例</a></li>
<li><a href="/buildWebWithGolangTw/docs/11.4/">11.4 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/12.0/">12.部署與維護</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/12.1/">12.1 應用日誌</a></li>
<li><a href="/buildWebWithGolangTw/docs/12.2/">12.2 網站錯誤處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/12.3/">12.3 應用部署</a></li>
<li><a href="/buildWebWithGolangTw/docs/12.4/">12.4 備份和還原</a></li>
<li><a href="/buildWebWithGolangTw/docs/12.5/">12.5 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/13.0/">13.如何設計一個 Web 框架</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/13.1/">13.1 專案規劃</a></li>
<li><a href="/buildWebWithGolangTw/docs/13.2/">13.2 自訂路由器設計</a></li>
<li><a href="/buildWebWithGolangTw/docs/13.3/">13.3 controller 設計</a></li>
<li><a href="/buildWebWithGolangTw/docs/13.4/">13.4 日誌和配置設計</a></li>
<li><a href="/buildWebWithGolangTw/docs/13.5/">13.5 實現部落格的增刪改</a></li>
<li><a href="/buildWebWithGolangTw/docs/13.6/">13.6 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/14.0/">14.擴充套件 Web 框架</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/14.1/">14.1 靜態檔案支援</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.2/">14.2 Session 支援</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.3/">14.3 表單支援</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.4/">14.4 使用者認證</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.5/">14.5 多語言支援</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.6/">14.6 pprof 支援</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.7/">14.7 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/ref/">附錄 A 參考資料</a></li>
</ul>







</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/buildWebWithGolangTw/svg/menu.svg" alt="Menu" />
  </label>
  <strong>12.3</strong>
</header>

      
<article class="markdown">

<h1 id="12-3-應用部署">12.3 應用部署</h1>

<p>程式開發完畢之後，我們現在要部署 Web 應用程式了，但是我們如何來部署這些應用程式呢？因為 Go 程式編譯之後是一個可執行檔案，編寫過 C 程式的讀者一定知道採用 daemon 就可以完美的實現程式後臺持續執行，但是目前 Go 還無法完美的實現 daemon，因此，針對 Go 的應用程式部署，我們可以利用第三方工具來管理，第三方的工具有很多，例如 Supervisord、upstart、daemontools 等，這小節我介紹目前自己系統中採用的工具 Supervisord。</p>

<h2 id="daemon">daemon</h2>

<p>目前 Go 程式還不能實現 daemon，詳細的見這個 Go 語言的 bug：&lt;<code>http://code.google.com/p/go/issues/detail?id=227</code>&gt;，大概的意思說很難從現有的使用的執行緒中 fork 一個出來，因為沒有一種簡單的方法來確保所有已經使用的執行緒的狀態一致性問題。</p>

<p>但是我們可以看到很多網上的一些實現 daemon 的方法，例如下面兩種方式：</p>

<ul>
<li><p>MarGo 的一個實現思路，使用 Command 來執行自身的應用，如果真想實現，那麼推薦這種方案</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Bool</span>(<span style="color:#e6db74">&#34;d&#34;</span>, <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;Whether or not to launch in the background(like a daemon)&#34;</span>)
<span style="color:#66d9ef">if</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">d</span> {
	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>],
		<span style="color:#e6db74">&#34;-close-fds&#34;</span>,
		<span style="color:#e6db74">&#34;-addr&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">addr</span>,
		<span style="color:#e6db74">&#34;-call&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">call</span>,
	)
	<span style="color:#a6e22e">serr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">StderrPipe</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">serr</span>)
	<span style="color:#a6e22e">s</span> = <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">TrimSpace</span>(<span style="color:#a6e22e">s</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">s</span>, []byte(<span style="color:#e6db74">&#34;addr: &#34;</span>)) {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">s</span>))
		<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Release</span>()
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;unexpected response from MarGo: `%s` error: `%v`\n&#34;</span>, <span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Kill</span>()
	}
}</code></pre></div></li>

<li><p>另一種是利用 syscall 的方案，但是這個方案並不完善：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;syscall&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">daemon</span>(<span style="color:#a6e22e">nochdir</span>, <span style="color:#a6e22e">noclose</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ret</span>, <span style="color:#a6e22e">ret2</span> <span style="color:#66d9ef">uintptr</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">uintptr</span>

	<span style="color:#a6e22e">darwin</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">OS</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;darwin&#34;</span>

	<span style="color:#75715e">// already a daemon
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">Getppid</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
	}

	<span style="color:#75715e">// fork off the parent process
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ret</span>, <span style="color:#a6e22e">ret2</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">RawSyscall</span>(<span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SYS_FORK</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
	}

	<span style="color:#75715e">// failure
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ret2</span> &lt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
	}

	<span style="color:#75715e">// handle exception for darwin
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">darwin</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ret2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> {
		<span style="color:#a6e22e">ret</span> = <span style="color:#ae81ff">0</span>
	}

	<span style="color:#75715e">// if we got a good PID, then we call exit the parent process.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ret</span> &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">0</span>)
	}

	<span style="color:#75715e">/* Change the file mode mask */</span>
	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">Umask</span>(<span style="color:#ae81ff">0</span>)

	<span style="color:#75715e">// create a new SID for the child process
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s_ret</span>, <span style="color:#a6e22e">s_errno</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">Setsid</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s_errno</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Error: syscall.Setsid errno: %d&#34;</span>, <span style="color:#a6e22e">s_errno</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s_ret</span> &lt; <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">nochdir</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Chdir</span>(<span style="color:#e6db74">&#34;/&#34;</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">noclose</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;/dev/null&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_RDWR</span>, <span style="color:#ae81ff">0</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Fd</span>()
			<span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">Dup2</span>(<span style="color:#a6e22e">fd</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdin</span>.<span style="color:#a6e22e">Fd</span>())
			<span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">Dup2</span>(<span style="color:#a6e22e">fd</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>.<span style="color:#a6e22e">Fd</span>())
			<span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">Dup2</span>(<span style="color:#a6e22e">fd</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>.<span style="color:#a6e22e">Fd</span>())
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
}</code></pre></div></li>
</ul>

<p>上面提出了兩種實現 Go 的 daemon 方案，但是我還是不推薦大家這樣去實現，因為官方還沒有正式的宣佈支援 daemon，當然第一種方案目前來看是比較可行的，而且目前開源函式庫 skynet 也在採用這個方案做 daemon。</p>

<h2 id="supervisord">Supervisord</h2>

<p>上面已經介紹了 Go 目前是有兩種方案來實現他的 daemon，但是官方本身還不支援這一塊，所以還是建議大家採用第三方成熟工具來管理我們的應用程式，這裡我給大家介紹一款目前使用比較廣泛的程序管理軟體：Supervisord。Supervisord 是用 Python 實現的一款非常實用的程序管理工具。supervisord 會幫你把管理的應用程式轉成 daemon 程式，而且可以方便的透過命令開啟、關閉、重啟等操作，而且它管理的程序一旦崩潰會自動重啟，這樣就可以保證程式執行中斷後的情況下有自我修復的功能。</p>

<blockquote>
<p>我前面在應用中踩過一個坑，就是因為所有的應用程式都是由 Supervisord 父程序生出來的，那麼當你修改了作業系統的檔案描述符之後，別忘記重啟 Supervisord，光重啟下面的應用程式沒用。當初我就是系統安裝好之後就先裝了 Supervisord，然後開始部署程式，修改檔案描述符，重啟程式，以為檔案描述符已經是 100000 了，其實 Supervisord 這個時候還是預設的 1024 個，導致他管理的程序所有的描述符也是 1024.開放之後壓力一上來系統就開始報檔案描述符用光了，查了很久才找到這個坑。</p>
</blockquote>

<h3 id="supervisord-安裝">Supervisord 安裝</h3>

<p>Supervisord 可以透過<code>sudo easy_install supervisor</code>安裝，當然也可以透過 Supervisord 官網下載後解壓並轉到原始碼所在的資料夾下執行<code>setup.py install</code>來安裝。</p>

<ul>
<li><p>使用 easy_install 必須安裝 setuptools</p>

<p>開啟<code>http://pypi.python.org/pypi/setuptools#files</code>，根據你係統的 python 的版本下載相應的檔案，然後執行<code>sh setuptoolsxxxx.egg</code>，這樣就可以使用 easy_install 命令來安裝 Supervisord。</p></li>
</ul>

<h3 id="supervisord-配置">Supervisord 配置</h3>

<p>Supervisord 預設的配置檔案路徑為/etc/supervisord.conf，透過文字編輯器修改這個檔案，下面是一個範例的配置檔案：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">;/etc/supervisord.conf
[unix_http_server]
file = /var/run/supervisord.sock
chmod = 0777
chown= root:root

[inet_http_server]
# Web 管理介面設定
port=9001
username = admin
password = yourpassword

[supervisorctl]
; 必須和&#39;unix_http_server&#39;裡面的設定匹配
serverurl = unix:///var/run/supervisord.sock

[supervisord]
logfile=/var/log/supervisord/supervisord.log ; (main log file;default $CWD/supervisord.log)
logfile_maxbytes=50MB       ; (max main logfile bytes b4 rotation;default 50MB)
logfile_backups=10          ; (num of main logfile rotation backups;default 10)
loglevel=info               ; (log level;default info; others: debug,warn,trace)
pidfile=/var/run/supervisord.pid ; (supervisord pidfile;default supervisord.pid)
nodaemon=true              ; (start in foreground if true;default false)
minfds=1024                 ; (min. avail startup file descriptors;default 1024)
minprocs=200                ; (min. avail process descriptors;default 200)
user=root                 ; (default is current user, required if root)
childlogdir=/var/log/supervisord/            ; (&#39;AUTO&#39; child log dir, default $TEMP)

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

; 管理的單個程序的配置，可以新增多個 program

[program:blogdemon]
command=/data/blog/blogdemon
autostart = true
startsecs = 5
user = root
redirect_stderr = true
stdout_logfile = /var/log/supervisord/blogdemon.log</code></pre></div>
<h3 id="supervisord-管理">Supervisord 管理</h3>

<p>Supervisord 安裝完成後有兩個可用的命令列 supervisor 和 supervisorctl，命令使用解釋如下：</p>

<ul>
<li>supervisord，初始啟動 Supervisord，啟動、管理配置中設定的程序。</li>
<li>supervisorctl stop programxxx，停止某一個程序(programxxx)，programxxx 為 [program:blogdemon] 裡配置的值，這個範例就是 blogdemon。</li>
<li>supervisorctl start programxxx，啟動某個程序</li>
<li>supervisorctl restart programxxx，重啟某個程序</li>
<li>supervisorctl stop all，停止全部程序，注：start、restart、stop 都不會載入最新的配置檔案。</li>
<li>supervisorctl reload，載入最新的配置檔案，並按新的配置啟動、管理所有程序。</li>
</ul>

<h2 id="小結">小結</h2>

<p>這小節我們介紹了 Go 如何實現 daemon 化，但是由於目前 Go 的 daemon 實現的不足，需要依靠第三方工具來實現應用程式的 daemon 管理的方式，所以在這裡介紹了一個用 python 寫的程序管理工具 Supervisord，透過 Supervisord 可以很方便的把我們的 Go 應用程式管理起來。</p>

<h2 id="links">links</h2>

<ul>
<li><a href="docs/preface">目錄</a></li>
<li>上一章: <a href="docs/12.2">網站錯誤處理</a></li>
<li>下一節: <a href="docs/12.4">備份和還原</a></li>
</ul>
</article>

      
<div class="book-footer justify-between">
  
  <div>
    
    <a href="/commit/fda25aafea9413c8ec77f5df29d5f6bb5f7dc3a6" title='Last modified Sep 21, 2019 by Jiuxiao' target="_blank" rel="noopener">
      <img src="/buildWebWithGolangTw/svg/calendar.svg" alt="Changed" /> Sep 21, 2019
    </a>
  </div>
  
  
</div>


      
    </div>

    
  

  <aside class="book-toc level-3 fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#12-3-應用部署">12.3 應用部署</a>
<ul>
<li><a href="#daemon">daemon</a></li>
<li><a href="#supervisord">Supervisord</a>
<ul>
<li><a href="#supervisord-安裝">Supervisord 安裝</a></li>
<li><a href="#supervisord-配置">Supervisord 配置</a></li>
<li><a href="#supervisord-管理">Supervisord 管理</a></li>
</ul></li>
<li><a href="#小結">小結</a></li>
<li><a href="#links">links</a></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148025936-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>
