<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>05.1 | 使用 Golang 打造 Web 應用程式</title>


<link rel="stylesheet" href="/buildWebWithGolangTw/book.min.89885fa0429ec73067282f26fc0c6d38cfc617a443ec4e835d47b821c52c6e92.css" integrity="sha256-iYhfoEKexzBnKC8m/AxtOM/GF6RD7E6DXUe4IcUsbpI=">


<script defer src="/buildWebWithGolangTw/search.min.4762838110f5450a8a33fcbe56c7ce734d09867f3e9ab5c1e6f7bbec99b65c68.js" integrity="sha256-R2KDgRD1RQqKM/y&#43;VsfOc00Jhn8&#43;mrXB5ve77Jm2XGg="></script>



<link rel="icon" href="/buildWebWithGolangTw/favicon.png" type="image/x-icon">

<base href="https://ezzdoc.com/buildWebWithGolangTw/">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://ezzdoc.com/buildWebWithGolangTw/"><span>使用 Golang 打造 Web 應用程式</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" readonly />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    
  
  
  

  <style>
  nav ul a[href$="\2f buildWebWithGolangTw\2f docs\2f 05.1\2f "] {
      color: #004ed0;
  }
  </style>

<ul>
<li><a href="/buildWebWithGolangTw/docs/preface/">目錄</a></li>
<li><a href="/buildWebWithGolangTw/docs/01.0/">1.Go 環境配置</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/01.1/">1.1 安裝 Go</a></li>
<li><a href="/buildWebWithGolangTw/docs/01.2/">1.2 GOPATH 與工作空間</a></li>
<li><a href="/buildWebWithGolangTw/docs/01.3/">1.3 Go 命令</a></li>
<li><a href="/buildWebWithGolangTw/docs/01.4/">1.4 Go 開發工具</a></li>
<li><a href="/buildWebWithGolangTw/docs/01.5/">1.5 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/02.0/">2.Go 語言基礎</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/02.1/">2.1 你好，Go</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.2/">2.2 Go 基礎</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.3/">2.3 流程和函式</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.4/">2.4 struct</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.5/">2.5 物件導向</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.6/">2.6 interface</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.7/">2.7 併發</a></li>
<li><a href="/buildWebWithGolangTw/docs/02.8/">2.8 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/03.0/">3.Web 基礎</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/03.1/">3.1 web 工作方式</a></li>
<li><a href="/buildWebWithGolangTw/docs/03.2/">3.2 Go 建立一個簡單的 web 服務</a></li>
<li><a href="/buildWebWithGolangTw/docs/03.3/">3.3 Go 如何使得 web 工作</a></li>
<li><a href="/buildWebWithGolangTw/docs/03.4/">3.4 Go 的 http 套件詳解</a></li>
<li><a href="/buildWebWithGolangTw/docs/03.5/">3.5 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/04.0/">4.表單</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/04.1/">4.1 處理表單的輸入</a></li>
<li><a href="/buildWebWithGolangTw/docs/04.2/">4.2 驗證表單的輸入</a></li>
<li><a href="/buildWebWithGolangTw/docs/04.3/">4.3 預防跨站指令碼</a></li>
<li><a href="/buildWebWithGolangTw/docs/04.4/">4.4 防止多次提交表單</a></li>
<li><a href="/buildWebWithGolangTw/docs/04.5/">4.5 處理檔案上傳</a></li>
<li><a href="/buildWebWithGolangTw/docs/04.6/">4.6 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/05.0/">5.訪問資料庫</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/05.1/">5.1 database/sql 介面</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.2/">5.2 使用 MySQL 資料庫</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.3/">5.3 使用 SQLite 資料庫</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.4/">5.4 使用 PostgreSQL 資料庫</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.5/">5.5 使用 Beego orm 函式庫進行 ORM 開發</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.6/">5.6 NOSQL 資料庫操作</a></li>
<li><a href="/buildWebWithGolangTw/docs/05.7/">5.7 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/06.0/">6.session 和資料儲存</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/06.1/">6.1 session 和 cookie</a></li>
<li><a href="/buildWebWithGolangTw/docs/06.2/">6.2 Go 如何使用 session</a></li>
<li><a href="/buildWebWithGolangTw/docs/06.3/">6.3 session 儲存</a></li>
<li><a href="/buildWebWithGolangTw/docs/06.4/">6.4 預防 session 劫持</a></li>
<li><a href="/buildWebWithGolangTw/docs/06.5/">6.5 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/07.0/">7.文字檔案處理</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/07.1/">7.1 XML 處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.2/">7.2 JSON 處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.3/">7.3 正則處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.4/">7.4 範本處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.5/">7.5 檔案操作</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.6/">7.6 字串處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/07.7/">7.7 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/08.0/">8.Web 服務</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/08.1/">8.1 Socket 程式設計</a></li>
<li><a href="/buildWebWithGolangTw/docs/08.2/">8.2 WebSocket</a></li>
<li><a href="/buildWebWithGolangTw/docs/08.3/">8.3 REST</a></li>
<li><a href="/buildWebWithGolangTw/docs/08.4/">8.4 RPC</a></li>
<li><a href="/buildWebWithGolangTw/docs/08.5/">8.5 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/09.0/">9.安全與加密</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/09.1/">9.1 預防 CSRF 攻擊</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.2/">9.2 確保輸入過濾</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.3/">9.3 避免 XSS 攻擊</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.4/">9.4 避免 SQL 注入</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.5/">9.5 儲存密碼</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.6/">9.6 加密和解密資料</a></li>
<li><a href="/buildWebWithGolangTw/docs/09.7/">9.7 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/10.0/">10.國際化和本地化</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/10.1/">10.1 設定預設地區</a></li>
<li><a href="/buildWebWithGolangTw/docs/10.2/">10.2 本地化資源</a></li>
<li><a href="/buildWebWithGolangTw/docs/10.3/">10.3 國際化站點</a></li>
<li><a href="/buildWebWithGolangTw/docs/10.4/">10.4 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/11.0/">11.錯誤處理，除錯和測試</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/11.1/">11.1 錯誤處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/11.2/">11.2 使用 GDB 除錯</a></li>
<li><a href="/buildWebWithGolangTw/docs/11.3/">11.3 Go 怎麼寫測試案例</a></li>
<li><a href="/buildWebWithGolangTw/docs/11.4/">11.4 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/12.0/">12.部署與維護</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/12.1/">12.1 應用日誌</a></li>
<li><a href="/buildWebWithGolangTw/docs/12.2/">12.2 網站錯誤處理</a></li>
<li><a href="/buildWebWithGolangTw/docs/12.3/">12.3 應用部署</a></li>
<li><a href="/buildWebWithGolangTw/docs/12.4/">12.4 備份和還原</a></li>
<li><a href="/buildWebWithGolangTw/docs/12.5/">12.5 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/13.0/">13.如何設計一個 Web 框架</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/13.1/">13.1 專案規劃</a></li>
<li><a href="/buildWebWithGolangTw/docs/13.2/">13.2 自訂路由器設計</a></li>
<li><a href="/buildWebWithGolangTw/docs/13.3/">13.3 controller 設計</a></li>
<li><a href="/buildWebWithGolangTw/docs/13.4/">13.4 日誌和配置設計</a></li>
<li><a href="/buildWebWithGolangTw/docs/13.5/">13.5 實現部落格的增刪改</a></li>
<li><a href="/buildWebWithGolangTw/docs/13.6/">13.6 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/14.0/">14.擴充套件 Web 框架</a>

<ul>
<li><a href="/buildWebWithGolangTw/docs/14.1/">14.1 靜態檔案支援</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.2/">14.2 Session 支援</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.3/">14.3 表單支援</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.4/">14.4 使用者認證</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.5/">14.5 多語言支援</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.6/">14.6 pprof 支援</a></li>
<li><a href="/buildWebWithGolangTw/docs/14.7/">14.7 小結</a></li>
</ul></li>
<li><a href="/buildWebWithGolangTw/docs/ref/">附錄 A 參考資料</a></li>
</ul>







</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/buildWebWithGolangTw/svg/menu.svg" alt="Menu" />
  </label>
  <strong>05.1</strong>
</header>

      
<article class="markdown">

<h1 id="5-1-database-sql-介面">5.1 database/sql 介面</h1>

<p>Go 與 PHP 不同的地方是 Go 官方沒有提供資料庫驅動，而是為開發資料庫驅動定義了一些標準介面，開發者可以根據定義的介面來開發相應的資料庫驅動，這樣做有一個好處，只要是按照標準介面開發的程式碼， 以後需要遷移資料庫時，不需要任何修改。那麼 Go 都定義了哪些標準介面呢？讓我們來詳細的分析一下</p>

<h2 id="sql-register">sql.Register</h2>

<p>這個存在於 database/sql 的函式是用來註冊資料庫驅動的，當第三方開發者開發資料庫驅動時，都會實現 init 函式，在 init 裡面會呼叫這個<code>Register(name string, driver driver.Driver)</code>完成本驅動的註冊。</p>

<p>我們來看一下 mymysql、sqlite3 的驅動裡面都是怎麼呼叫的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#75715e">//https://github.com/mattn/go-sqlite3 驅動
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;sqlite3&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SQLiteDriver</span>{})
}

<span style="color:#75715e">//https://github.com/mikespook/mymysql 驅動
</span><span style="color:#75715e">// Driver automatically registered in database/sql
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">d</span> = <span style="color:#a6e22e">Driver</span>{<span style="color:#a6e22e">proto</span>: <span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">raddr</span>: <span style="color:#e6db74">&#34;127.0.0.1:3306&#34;</span>}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;SET NAMES utf8&#34;</span>)
	<span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;mymysql&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">d</span>)
}</code></pre></div>
<p>我們看到第三方資料庫驅動都是透過呼叫這個函式來註冊自己的資料庫驅動名稱以及相應的 driver 實現。在 database/sql 內部透過一個 map 來儲存使用者定義的相應驅動。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">drivers</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">Driver</span>)

<span style="color:#a6e22e">drivers</span>[<span style="color:#a6e22e">name</span>] = <span style="color:#a6e22e">driver</span></code></pre></div>
<p>因此透過 database/sql 的註冊函式可以同時註冊多個數據函式庫驅動，只要不重複。</p>

<blockquote>
<p>在我們使用 database/sql 介面和第三方函式庫的時候經常看到如下:</p>

<pre><code>  import (
      &quot;database/sql&quot;
      _ &quot;github.com/mattn/go-sqlite3&quot;
  )
</code></pre>

<p>新手都會被這個 <code>_</code> 所迷惑，其實這個就是 Go 設計的巧妙之處，我們在變數賦值的時候經常看到這個符號，它是用來忽略變數賦值的佔位符，那麼套件引入用到這個符號也是相似的作用，這兒使用 <code>_</code> 的意思是引入後面的套件名而不直接使用這個套件中定義的函式，變數等資源。</p>

<p>我們在 2.3 節流程和函式一節中介紹過 init 函式的初始化過程，套件在引入的時候會自動呼叫套件的 init 函式以完成對套件的初始化。因此，我們引入上面的資料庫驅動套件之後會自動去呼叫 init 函式，然後在 init 函式裡面註冊這個資料庫驅動，這樣我們就可以在接下來的程式碼中直接使用這個資料庫驅動了。</p>
</blockquote>

<h2 id="driver-driver">driver.Driver</h2>

<p>Driver 是一個數據函式庫驅動的介面，他定義了一個 method： Open(name string)，這個方法回傳一個數據函式庫的 Conn 介面。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Driver</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">Conn</span>, <span style="color:#66d9ef">error</span>)
}</code></pre></div>
<p>回傳的 Conn 只能用來進行一次 goroutine 的操作，也就是說不能把這個 Conn 應用於 Go 的多個 goroutine 裡面。如下程式碼會出現錯誤</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#f92672">...</span>
<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">goroutineA</span> (<span style="color:#a6e22e">Conn</span>)  <span style="color:#75715e">//執行查詢操作
</span><span style="color:#75715e"></span><span style="color:#66d9ef">go</span> <span style="color:#a6e22e">goroutineB</span> (<span style="color:#a6e22e">Conn</span>)  <span style="color:#75715e">//執行插入操作
</span><span style="color:#75715e"></span><span style="color:#f92672">...</span></code></pre></div>
<p>上面這樣的程式碼可能會使 Go 不知道某個操作究竟是由哪個 goroutine 發起的，從而導致資料混亂，比如可能會把 goroutineA 裡面執行的查詢操作的結果回傳給 goroutineB 從而使 B 錯誤地把此結果當成自己執行的插入資料。</p>

<p>第三方驅動都會定義這個函式，它會解析 name 參數來取得相關資料庫的連線資訊，解析完成後，它將使用此資訊來初始化一個 Conn 並回傳它。</p>

<h2 id="driver-conn">driver.Conn</h2>

<p>Conn 是一個數據函式庫連線的介面定義，他定義了一系列方法，這個 Conn 只能應用在一個 goroutine 裡面，不能使用在多個 goroutine 裡面，詳情請參考上面的說明。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Conn</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Prepare</span>(<span style="color:#a6e22e">query</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">Stmt</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">Close</span>() <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Begin</span>() (<span style="color:#a6e22e">Tx</span>, <span style="color:#66d9ef">error</span>)
}</code></pre></div>
<p>Prepare 函式回傳與當前連線相關的執行 Sql 語句的準備狀態，可以進行查詢、刪除等操作。</p>

<p>Close 函式關閉當前的連線，執行釋放連線擁有的資源等清理工作。因為驅動實現了 database/sql 裡面建議的 conn pool，所以你不用再去實現快取 conn 之類別的，這樣會容易引起問題。</p>

<p>Begin 函式回傳一個代表交易處理的 Tx，透過它你可以進行查詢，更新等操作，或者對交易進行回復 (Rollback)、提交。</p>

<h2 id="driver-stmt">driver.Stmt</h2>

<p>Stmt 是一種準備好的狀態，和 Conn 相關聯，而且只能應用於一個 goroutine 中，不能應用於多個 goroutine。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Stmt</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Close</span>() <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">NumInput</span>() <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">Exec</span>(<span style="color:#a6e22e">args</span> []<span style="color:#a6e22e">Value</span>) (<span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">args</span> []<span style="color:#a6e22e">Value</span>) (<span style="color:#a6e22e">Rows</span>, <span style="color:#66d9ef">error</span>)
}</code></pre></div>
<p>Close 函式關閉當前的連結狀態，但是如果當前正在執行 query，query 還是有效回傳 rows 資料。</p>

<p>NumInput 函式回傳當前預留參數的個數，當回傳 &gt;=0 時資料庫驅動就會智慧檢查呼叫者的參數。當資料庫驅動套件不知道預留參數的時候，回傳-1。</p>

<p>Exec 函式執行 Prepare 準備好的 sql，傳入參數執行 update/insert 等操作，回傳 Result 資料</p>

<p>Query 函式執行 Prepare 準備好的 sql，傳入需要的參數執行 select 操作，回傳 Rows 結果集</p>

<h2 id="driver-tx">driver.Tx</h2>

<p>交易處理一般就兩個過程，提交或者回復 (Rollback)。資料庫驅動裡面也只需要實現這兩個函式就可以</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Tx</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Commit</span>() <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Rollback</span>() <span style="color:#66d9ef">error</span>
}</code></pre></div>
<p>這兩個函式一個用來提交一個交易，一個用來回復 (Rollback)交易。</p>

<h2 id="driver-execer">driver.Execer</h2>

<p>這是一個 Conn 可選擇實現的介面</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Execer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Exec</span>(<span style="color:#a6e22e">query</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">args</span> []<span style="color:#a6e22e">Value</span>) (<span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>)
}</code></pre></div>
<p>如果這個介面沒有定義，那麼在呼叫 DB.Exec，就會首先呼叫 Prepare 回傳 Stmt，然後執行 Stmt 的 Exec，然後關閉 Stmt。</p>

<h2 id="driver-result">driver.Result</h2>

<p>這個是執行 Update/Insert 等操作回傳的結果介面定義</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Result</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">LastInsertId</span>() (<span style="color:#66d9ef">int64</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">RowsAffected</span>() (<span style="color:#66d9ef">int64</span>, <span style="color:#66d9ef">error</span>)
}</code></pre></div>
<p>LastInsertId 函式回傳由資料庫執行插入操作得到的自增 ID 號。</p>

<p>RowsAffected 函式回傳 query 操作影響的資料條目數。</p>

<h2 id="driver-rows">driver.Rows</h2>

<p>Rows 是執行查詢回傳的結果集介面定義</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Rows</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Columns</span>() []<span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Close</span>() <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Next</span>(<span style="color:#a6e22e">dest</span> []<span style="color:#a6e22e">Value</span>) <span style="color:#66d9ef">error</span>
}</code></pre></div>
<p>Columns 函式回傳查詢資料庫表的欄位資訊，這個回傳的 slice 和 sql 查詢的欄位一一對應，而不是回傳整個表的所有欄位。</p>

<p>Close 函式用來關閉 Rows 迭代器。</p>

<p>Next 函式用來回傳下一條資料，把資料賦值給 dest。dest 裡面的元素必須是 driver.Value 的值除了 string，回傳的資料裡面所有的 string 都必須要轉換成[]byte。如果最後沒資料了，Next 函式最後回傳 io.EOF。</p>

<h2 id="driver-rowsaffected">driver.RowsAffected</h2>

<p>RowsAffected 其實就是一個 int64 的別名，但是他實現了 Result 介面，用來底層實現 Result 的表示方式</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">RowsAffected</span> <span style="color:#66d9ef">int64</span>

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">RowsAffected</span>) <span style="color:#a6e22e">LastInsertId</span>() (<span style="color:#66d9ef">int64</span>, <span style="color:#66d9ef">error</span>)

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#a6e22e">RowsAffected</span>) <span style="color:#a6e22e">RowsAffected</span>() (<span style="color:#66d9ef">int64</span>, <span style="color:#66d9ef">error</span>)</code></pre></div>
<h2 id="driver-value">driver.Value</h2>

<p>Value 其實就是一個空介面，他可以容納任何的資料</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Value</span> <span style="color:#66d9ef">interface</span>{}</code></pre></div>
<p>drive 的 Value 是驅動必須能夠操作的 Value，Value 要麼是 nil，要麼是下面的任意一種</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">int64</span>
<span style="color:#66d9ef">float64</span>
<span style="color:#66d9ef">bool</span>
[]<span style="color:#66d9ef">byte</span>
<span style="color:#66d9ef">string</span>   [<span style="color:#f92672">*</span>]<span style="color:#a6e22e">除了</span> <span style="color:#a6e22e">Rows</span>.<span style="color:#a6e22e">Next</span> <span style="color:#a6e22e">回傳的不能是</span> <span style="color:#66d9ef">string</span>.
<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span></code></pre></div>
<h2 id="driver-valueconverter">driver.ValueConverter</h2>

<p>ValueConverter 介面定義了如何把一個普通的值轉化成 driver.Value 的介面</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ValueConverter</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">ConvertValue</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">Value</span>, <span style="color:#66d9ef">error</span>)
}</code></pre></div>
<p>在開發的資料庫驅動套件裡面實現這個介面的函式在很多地方會使用到，這個 ValueConverter 有很多好處：</p>

<ul>
<li>轉化 driver.value 到資料庫表相應的欄位，例如 int64 的資料如何轉化成資料庫表 uint16 欄位</li>
<li>把資料庫查詢結果轉化成 driver.Value 值</li>
<li>在 scan 函式裡面如何把 driver.Value 值轉化成使用者定義的值</li>
</ul>

<h2 id="driver-valuer">driver.Valuer</h2>

<p>Valuer 介面定義了回傳一個 driver.Value 的方式</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Valuer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Value</span>() (<span style="color:#a6e22e">Value</span>, <span style="color:#66d9ef">error</span>)
}</code></pre></div>
<p>很多型別都實現了這個 Value 方法，用來自身與 driver.Value 的轉化。</p>

<p>透過上面的講解，你應該對於驅動的開發有了一個基本的了解，一個驅動只要實現了這些介面就能完成增刪查改等基本操作了，剩下的就是與相應的資料庫進行資料互動等細節問題了，在此不再贅述。</p>

<h2 id="database-sql">database/sql</h2>

<p>database/sql 在 database/sql/driver 提供的介面基礎上定義了一些更高階的方法，用以簡化資料庫操作，同時內部還建議性地實現一個 conn pool。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DB</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">driver</span> 	 <span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">Driver</span>
	<span style="color:#a6e22e">dsn</span>    	 <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">mu</span>       <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span> <span style="color:#75715e">// protects freeConn and closed
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">freeConn</span> []<span style="color:#a6e22e">driver</span>.<span style="color:#a6e22e">Conn</span>
	<span style="color:#a6e22e">closed</span>   <span style="color:#66d9ef">bool</span>
}</code></pre></div>
<p>我們可以看到 Open 函式回傳的是 DB 物件，裡面有一個 freeConn，它就是那個簡易的連線池。它的實現相當簡單或者說簡陋，就是當執行<code>db.prepare</code> -&gt; <code>db.prepareDC</code>的時候會<code>defer dc.releaseConn</code>，然後呼叫<code>db.putConn</code>，也就是把這個連線放入連線池，每次呼叫<code>db.conn</code>的時候會先判斷 freeConn 的長度是否大於 0，大於 0 說明有可以複用的 conn，直接拿出來用就是了，如果不大於 0，則建立一個 conn，然後再回傳之。</p>

<h2 id="links">links</h2>

<ul>
<li><a href="docs/preface">目錄</a></li>
<li>上一節: <a href="docs/05.0">訪問資料庫</a></li>
<li>下一節: <a href="docs/05.2">使用 MySQL 資料庫</a></li>
</ul>
</article>

      
<div class="book-footer justify-between">
  
  <div>
    
    <a href="/commit/fda25aafea9413c8ec77f5df29d5f6bb5f7dc3a6" title='Last modified Sep 21, 2019 by Jiuxiao' target="_blank" rel="noopener">
      <img src="/buildWebWithGolangTw/svg/calendar.svg" alt="Changed" /> Sep 21, 2019
    </a>
  </div>
  
  
</div>


      
    </div>

    
  

  <aside class="book-toc level-3 fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#5-1-database-sql-介面">5.1 database/sql 介面</a>
<ul>
<li><a href="#sql-register">sql.Register</a></li>
<li><a href="#driver-driver">driver.Driver</a></li>
<li><a href="#driver-conn">driver.Conn</a></li>
<li><a href="#driver-stmt">driver.Stmt</a></li>
<li><a href="#driver-tx">driver.Tx</a></li>
<li><a href="#driver-execer">driver.Execer</a></li>
<li><a href="#driver-result">driver.Result</a></li>
<li><a href="#driver-rows">driver.Rows</a></li>
<li><a href="#driver-rowsaffected">driver.RowsAffected</a></li>
<li><a href="#driver-value">driver.Value</a></li>
<li><a href="#driver-valueconverter">driver.ValueConverter</a></li>
<li><a href="#driver-valuer">driver.Valuer</a></li>
<li><a href="#database-sql">database/sql</a></li>
<li><a href="#links">links</a></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148025936-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>
